import { tursoClient } from '../lib/tursoClient.js';
import { randomUUID } from 'crypto';

// ===============================================
// CONTROLADOR DE AUDITOR√çAS - SGC PRO
// ===============================================

// Obtener todas las auditor√≠as
export const getAllAuditorias = async (req, res) => {
  try {
    console.log('üîç Obteniendo auditor√≠as...');
    
    const result = await tursoClient.execute({
      sql: `SELECT * FROM auditorias WHERE organization_id = '2' ORDER BY fecha_programada DESC`,
      args: []
    });

    console.log(`‚úÖ ${result.rows.length} auditor√≠as encontradas`);
    
    res.json({
      success: true,
      data: result.rows,
      total: result.rows.length
    });
    
  } catch (error) {
    console.error('‚ùå Error obteniendo auditor√≠as:', error);
    res.status(500).json({
      success: false,
      message: 'Error al obtener auditor√≠as',
      error: error.message
    });
  }
};

// Obtener auditor√≠a por ID
export const getAuditoriaById = async (req, res) => {
  try {
    const { id } = req.params;
    
    console.log(`üîç Obteniendo auditor√≠a ${id}...`);
    
    const result = await tursoClient.execute({
      sql: `SELECT * FROM auditorias WHERE id = ? AND organization_id = '2'`,
      args: [id]
    });

    if (result.rows.length === 0) {
      return res.status(404).json({
        success: false,
        message: 'Auditor√≠a no encontrada'
      });
    }

    console.log(`‚úÖ Auditor√≠a ${id} encontrada`);
    
    res.json({
      success: true,
      data: result.rows[0]
    });
    
  } catch (error) {
    console.error('‚ùå Error obteniendo auditor√≠a:', error);
    res.status(500).json({
      success: false,
      message: 'Error al obtener auditor√≠a',
      error: error.message
    });
  }
};

// Crear nueva auditor√≠a
export const createAuditoria = async (req, res) => {
  try {
    console.log('üÜï Creando nueva auditor√≠a...');
    console.log('üìã Datos recibidos:', req.body);
    
    const {
      codigo,
      titulo,
      area,
      responsable_id,
      fecha_programada,
      objetivos,
      alcance,
      criterios,
      estado = 'planificada'
    } = req.body;

    // Validaciones b√°sicas
    if (!titulo || !area || !fecha_programada || !objetivos) {
      return res.status(400).json({
        success: false,
        message: 'Faltan campos obligatorios: t√≠tulo, √°rea, fecha programada, objetivos'
      });
    }

    const auditoriaId = randomUUID();
    const timestamp = new Date().toISOString();

    const result = await tursoClient.execute({
      sql: `
        INSERT INTO auditorias (
          id, codigo, titulo, area, responsable_id, fecha_programada,
          objetivos, alcance, criterios, estado, organization_id,
          created_at, updated_at
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
      `,
      args: [
        auditoriaId,
        codigo || `AUD-${new Date().getFullYear()}-${Math.floor(Math.random() * 1000).toString().padStart(3, '0')}`,
        titulo,
        area,
        responsable_id || null,
        fecha_programada,
        objetivos,
        alcance || null,
        criterios || null,
        estado,
        req.user.organization_id,
        timestamp,
        timestamp
      ]
    });

    console.log(`‚úÖ Auditor√≠a creada con ID: ${auditoriaId}`);
    
    res.status(201).json({
      success: true,
      data: {
        id: auditoriaId,
        codigo,
        titulo,
        area
      },
      message: 'Auditor√≠a creada exitosamente'
    });
    
  } catch (error) {
    console.error('‚ùå Error creando auditor√≠a:', error);
    res.status(500).json({
      success: false,
      message: 'Error al crear auditor√≠a',
      error: error.message
    });
  }
};

// Actualizar auditor√≠a
export const updateAuditoria = async (req, res) => {
  try {
    const { id } = req.params;
    console.log(`‚úèÔ∏è Actualizando auditor√≠a ${id}...`);
    
    const {
      titulo,
      area,
      responsable_id,
      fecha_programada,
      fecha_ejecucion,
      objetivos,
      alcance,
      criterios,
      resultados,
      observaciones,
      estado
    } = req.body;

    const timestamp = new Date().toISOString();

    const result = await tursoClient.execute({
      sql: `
        UPDATE auditorias SET
          titulo = COALESCE(?, titulo),
          area = COALESCE(?, area),
          responsable_id = ?,
          fecha_programada = COALESCE(?, fecha_programada),
          fecha_ejecucion = ?,
          objetivos = COALESCE(?, objetivos),
          alcance = ?,
          criterios = ?,
          resultados = ?,
          observaciones = ?,
          estado = COALESCE(?, estado),
          updated_at = ?
        WHERE id = ? AND organization_id = ?
      `,
      args: [
        titulo,
        area,
        responsable_id || null,
        fecha_programada,
        fecha_ejecucion || null,
        objetivos,
        alcance || null,
        criterios || null,
        resultados || null,
        observaciones || null,
        estado,
        timestamp,
        id,
        req.user.organization_id
      ]
    });

    if (result.rowsAffected === 0) {
      return res.status(404).json({
        success: false,
        message: 'Auditor√≠a no encontrada'
      });
    }

    console.log(`‚úÖ Auditor√≠a ${id} actualizada`);
    
    res.json({
      success: true,
      message: 'Auditor√≠a actualizada exitosamente'
    });
    
  } catch (error) {
    console.error('‚ùå Error actualizando auditor√≠a:', error);
    res.status(500).json({
      success: false,
      message: 'Error al actualizar auditor√≠a',
      error: error.message
    });
  }
};

// Eliminar auditor√≠a
export const deleteAuditoria = async (req, res) => {
  try {
    const { id } = req.params;
    console.log(`üóëÔ∏è Eliminando auditor√≠a ${id}...`);
    
    const result = await tursoClient.execute({
      sql: 'DELETE FROM auditorias WHERE id = ? AND organization_id = ?',
      args: [id, req.user.organization_id]
    });

    if (result.rowsAffected === 0) {
      return res.status(404).json({
        success: false,
        message: 'Auditor√≠a no encontrada'
      });
    }

    console.log(`‚úÖ Auditor√≠a ${id} eliminada`);
    
    res.json({
      success: true,
      message: 'Auditor√≠a eliminada exitosamente'
    });
    
  } catch (error) {
    console.error('‚ùå Error eliminando auditor√≠a:', error);
    res.status(500).json({
      success: false,
      message: 'Error al eliminar auditor√≠a',
      error: error.message
    });
  }
};

// ===============================================
// GESTI√ìN DE ASPECTOS
// ===============================================

// Obtener aspectos de una auditor√≠a
export const getAspectos = async (req, res) => {
  try {
    const { auditoriaId } = req.params;
    console.log(`üîç Obteniendo aspectos de auditor√≠a ${auditoriaId}...`);
    
    const result = await tursoClient.execute({
      sql: `
        SELECT aa.*, p.nombre as proceso_original
        FROM auditoria_aspectos aa
        LEFT JOIN procesos p ON aa.proceso_id = p.id
        WHERE aa.auditoria_id = ?
        ORDER BY aa.created_at ASC
      `,
      args: [auditoriaId]
    });

    console.log(`‚úÖ ${result.rows.length} aspectos encontrados`);
    
    res.json({
      success: true,
      data: result.rows,
      total: result.rows.length
    });
    
  } catch (error) {
    console.error('‚ùå Error obteniendo aspectos:', error);
    res.status(500).json({
      success: false,
      message: 'Error al obtener aspectos',
      error: error.message
    });
  }
};

// Agregar aspecto a auditor√≠a
export const addAspecto = async (req, res) => {
  try {
    const { auditoriaId } = req.params;
    console.log(`‚ûï Agregando aspecto a auditor√≠a ${auditoriaId}...`);
    
    const {
      proceso_id,
      proceso_nombre,
      documentacion_referenciada,
      auditor_nombre,
      observaciones,
      conformidad
    } = req.body;

    if (!proceso_nombre) {
      return res.status(400).json({
        success: false,
        message: 'El nombre del proceso es obligatorio'
      });
    }

    const aspectoId = randomUUID();
    const timestamp = new Date().toISOString();

    const result = await tursoClient.execute({
      sql: `
        INSERT INTO auditoria_aspectos (
          id, auditoria_id, proceso_id, proceso_nombre,
          documentacion_referenciada, auditor_nombre,
          observaciones, conformidad, created_at
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
      `,
      args: [
        aspectoId,
        auditoriaId,
        proceso_id || null,
        proceso_nombre,
        documentacion_referenciada || null,
        auditor_nombre || null,
        observaciones || null,
        conformidad || null,
        timestamp
      ]
    });

    console.log(`‚úÖ Aspecto agregado con ID: ${aspectoId}`);
    
    res.status(201).json({
      success: true,
      data: {
        id: aspectoId,
        proceso_nombre
      },
      message: 'Aspecto agregado exitosamente'
    });
    
  } catch (error) {
    console.error('‚ùå Error agregando aspecto:', error);
    res.status(500).json({
      success: false,
      message: 'Error al agregar aspecto',
      error: error.message
    });
  }
};

// Actualizar aspecto
export const updateAspecto = async (req, res) => {
  try {
    const { id } = req.params;
    console.log(`‚úèÔ∏è Actualizando aspecto ${id}...`);
    
    const {
      proceso_id,
      proceso_nombre,
      documentacion_referenciada,
      auditor_nombre,
      observaciones,
      conformidad
    } = req.body;

    const result = await tursoClient.execute({
      sql: `
        UPDATE auditoria_aspectos SET
          proceso_id = ?,
          proceso_nombre = COALESCE(?, proceso_nombre),
          documentacion_referenciada = ?,
          auditor_nombre = ?,
          observaciones = ?,
          conformidad = ?
        WHERE id = ?
      `,
      args: [
        proceso_id || null,
        proceso_nombre,
        documentacion_referenciada || null,
        auditor_nombre || null,
        observaciones || null,
        conformidad || null,
        id
      ]
    });

    if (result.rowsAffected === 0) {
      return res.status(404).json({
        success: false,
        message: 'Aspecto no encontrado'
      });
    }

    console.log(`‚úÖ Aspecto ${id} actualizado`);
    
    res.json({
      success: true,
      message: 'Aspecto actualizado exitosamente'
    });
    
  } catch (error) {
    console.error('‚ùå Error actualizando aspecto:', error);
    res.status(500).json({
      success: false,
      message: 'Error al actualizar aspecto',
      error: error.message
    });
  }
};

// Eliminar aspecto
export const deleteAspecto = async (req, res) => {
  try {
    const { id } = req.params;
    console.log(`üóëÔ∏è Eliminando aspecto ${id}...`);
    
    const result = await tursoClient.execute({
      sql: 'DELETE FROM auditoria_aspectos WHERE id = ?',
      args: [id]
    });

    if (result.rowsAffected === 0) {
      return res.status(404).json({
        success: false,
        message: 'Aspecto no encontrado'
      });
    }

    console.log(`‚úÖ Aspecto ${id} eliminado`);
    
    res.json({
      success: true,
      message: 'Aspecto eliminado exitosamente'
    });
    
  } catch (error) {
    console.error('‚ùå Error eliminando aspecto:', error);
    res.status(500).json({
      success: false,
      message: 'Error al eliminar aspecto',
      error: error.message
    });
  }
};
